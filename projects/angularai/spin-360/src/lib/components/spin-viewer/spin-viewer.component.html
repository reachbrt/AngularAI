<div
  class="spin-viewer"
  #container
  [class.dragging]="isDragging"
  [class.hovering]="isHovering"
  [class.playing]="isPlaying"
  [class.mode-gif]="mode === 'gif'"
  [class.mode-frames]="mode === 'frames'"
  (mouseenter)="onMouseEnter()"
  (mouseleave)="onMouseLeave(); onMouseUp()"
  (mousedown)="onMouseDown($event)"
  (mousemove)="onMouseMove($event)"
  (mouseup)="onMouseUp()"
  (touchstart)="onTouchStart($event)"
  (touchmove)="onTouchMove($event)"
  (touchend)="onTouchEnd()"
  (click)="onClick()"
  (wheel)="onWheel($event)">

  @if (isLoading) {
    <div class="loading">
      <div class="spinner"></div>
      <span>Loading 360¬∞ view...</span>
    </div>
  } @else {
    <div class="image-container" [style.transform]="'scale(' + zoom + ')'">
      <!-- GIF mode: show static/gif based on hover -->
      @if (mode === 'gif') {
        <img
          [src]="displayImage"
          alt="360 view"
          draggable="false"
          [class.is-gif]="isHovering && gifUrl" />
        @if (!isHovering && gifUrl) {
          <div class="gif-indicator">
            <span class="gif-badge">GIF</span>
            <span class="hover-hint">Hover to play</span>
          </div>
        }
      } @else {
        <!-- Frames mode: show current frame -->
        <img [src]="currentImage" alt="360 view" draggable="false" />
      }

      @for (hotspot of visibleHotspots; track hotspot.id) {
        <div
          class="hotspot"
          [style.left.%]="hotspot.x"
          [style.top.%]="hotspot.y"
          [class.ai-generated]="hotspot.aiGenerated"
          (click)="onHotspotClick(hotspot); $event.stopPropagation()">
          <div class="hotspot-dot"></div>
          <div class="hotspot-label">
            <strong>{{ hotspot.label }}</strong>
            @if (hotspot.description) {
              <p>{{ hotspot.description }}</p>
            }
          </div>
        </div>
      }
    </div>
  }

  @if (showControls && !isLoading && mode === 'frames') {
    <div class="controls">
      <button (click)="prevFrame(); $event.stopPropagation()" title="Previous">‚óÄ</button>
      <button (click)="toggleAutoRotate(); $event.stopPropagation()" [title]="autoRotateInterval ? 'Stop' : 'Auto-rotate'">
        {{ autoRotateInterval ? '‚è∏' : '‚ñ∂' }}
      </button>
      <button (click)="nextFrame(); $event.stopPropagation()" title="Next">‚ñ∂</button>

      @if (zoomable) {
        <span class="divider">|</span>
        <button (click)="zoom = zoom + 0.5; $event.stopPropagation()" [disabled]="zoom >= maxZoom" title="Zoom in">üîç+</button>
        <button (click)="zoom = zoom - 0.5; $event.stopPropagation()" [disabled]="zoom <= 1" title="Zoom out">üîç-</button>
        <button (click)="resetZoom(); $event.stopPropagation()" [disabled]="zoom === 1" title="Reset zoom">‚Ü∫</button>
      }
    </div>

    <div class="frame-indicator">
      {{ currentFrame + 1 }} / {{ images.length }}
    </div>
  }
</div>

